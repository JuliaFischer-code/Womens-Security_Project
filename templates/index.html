<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Women's Security App - Startseite</title>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA3hP_MBMqhB_EdFo7ZIJMmNxWJYORrYXY&libraries=places,directions"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h1, p {
            text-align: center;
            margin: 10px 0;
        }

        #map {
            width: 90%;
            height: 500px;
            margin: 20px 0;
        }

        #search-container {
            width: 90%;
            max-width: 800px;
            margin: 10px 0;
            display: flex;
            gap: 10px;
        }

        #search-input {
            flex: 1;
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        #search-button {
            padding: 10px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        #search-button:hover {
            background-color: #45a049;
        }

        #travel-mode-container {
            margin: 10px 0;
        }

        #safe-places {
            width: 90%;
            max-width: 800px;
            margin: 20px 0;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: #f9f9f9;
        }

        #safe-places ul {
            list-style-type: none;
            padding: 0;
        }

        #safe-places li {
            padding: 5px 0;
            cursor: pointer;
            border-bottom: 1px solid #ddd;
        }

        #safe-places li:hover {
            background-color: #efefef;
        }

        #action-buttons {
            display: flex;
            gap: 20px;
            margin: 20px 0;
        }

        .action-button {
            width: 100px;
            height: 100px;
            border: none;
            border-radius: 50%;
            font-size: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .action-button:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 12px rgba(0, 0, 0, 0.3);
        }

        .call {
            background-color: #4CAF50;
            color: white;
        }

        .chat {
            background-color: #2196F3;
            color: white;
        }

        .sos {
            background-color: #F44336;
            color: white;
        }
    </style>
</head>
<body>
    <h1>Women's Security App</h1>
    <p>Feel Safe, Stay Connected</p>

    <div id="action-buttons">
        <a href="/call"><button class="action-button call" title="Call an emergency contact">ðŸ“ž</button></a>
        <a href="/chat"><button class="action-button chat" title="Start a chat">ðŸ’¬</button></a>
        <a href="/sos"><button class="action-button sos" title="Send an SOS alert">ðŸ””</button></a>
    </div>

    <div id="search-container">
        <input type="text" id="search-input" placeholder="Search for a location, restaurant...">
        <button id="search-button">Search</button>
    </div>

    <div id="travel-mode-container">
        <label for="travel-mode">Select Travel Mode:</label>
        <select id="travel-mode">
            <option value="WALKING">Walking</option>
            <option value="DRIVING">Driving</option>
            <option value="BICYCLING">Bicycling</option>
            <option value="TRANSIT">Transit</option>
        </select>
    </div>

    <div id="map"></div>

    <div id="safe-places">
        <h3>Top 5 Safe Places</h3>
        <ul id="places-list">
            <!-- Safe Places will be dynamically populated here -->
        </ul>
    </div>

    <script>
        let map;
        let userLocation;
        let directionsService;
        let directionsRenderer;

        function initMap() {
            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer();

            // Initialize the map
            map = new google.maps.Map(document.getElementById("map"), {
                center: { lat: 49.1427, lng: 9.2109 }, // Default to Heilbronn, Germany
                zoom: 13
            });

            directionsRenderer.setMap(map);

            // Get user location
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        map.setCenter(userLocation);

                        // Add a marker for the user's location
                        new google.maps.Marker({
                            position: userLocation,
                            map,
                            title: "Your Location"
                        });

                        // Fetch nearby safe places
                        fetchSafePlaces(userLocation);
                    },
                    () => {
                        console.log("Geolocation failed. Using default location.");
                        fetchSafePlaces({ lat: 49.1427, lng: 9.2109 }); // Fallback to Heilbronn
                    }
                );
            } else {
                console.log("Geolocation is not supported by this browser.");
                fetchSafePlaces({ lat: 49.1427, lng: 9.2109 }); // Fallback to Heilbronn
            }

            // Add search functionality
            const searchInput = document.getElementById("search-input");
            const searchButton = document.getElementById("search-button");

            searchButton.addEventListener("click", () => {
                const query = searchInput.value;
                if (!query) return;

                const request = {
                    query,
                    fields: ["name", "geometry"],
                };

                const service = new google.maps.places.PlacesService(map);
                service.findPlaceFromQuery(request, (results, status) => {
                    if (status === google.maps.places.PlacesServiceStatus.OK && results[0]) {
                        const place = results[0];
                        map.setCenter(place.geometry.location);
                        new google.maps.Marker({
                            position: place.geometry.location,
                            map,
                            title: place.name
                        });

                        // Calculate and display route
                        if (userLocation) {
                            calculateRoute(userLocation, place.geometry.location);
                        }
                    } else {
                        alert("Place not found!");
                    }
                });
            });

            // Add click event to the map for generating route
            map.addListener("click", (event) => {
                if (userLocation) {
                    calculateRoute(userLocation, event.latLng);
                }
            });
        }

        function calculateRoute(origin, destination) {
            const travelMode = document.getElementById("travel-mode").value;
            const request = {
                origin,
                destination,
                travelMode: google.maps.TravelMode[travelMode]
            };

            directionsService.route(request, (result, status) => {
                if (status === google.maps.DirectionsStatus.OK) {
                    directionsRenderer.setDirections(result);
                } else {
                    alert("Could not calculate route: " + status);
                }
            });
        }

        function fetchSafePlaces(location) {
            const service = new google.maps.places.PlacesService(map);
            const request = {
                location: location,
                radius: 5000,
                type: ["hospital", "police", "university", "restaurant", "bar", "city_hall"]
            };

            service.nearbySearch(request, (results, status) => {
                if (status === google.maps.places.PlacesServiceStatus.OK) {
                    populateSafePlaces(results.slice(0, 5)); // Top 5 places
                } else {
                    console.error("Places API failed with status:", status);
                }
            });
        }

        function populateSafePlaces(places) {
            const placesList = document.getElementById("places-list");
            placesList.innerHTML = "";

            places.forEach((place) => {
                const listItem = document.createElement("li");
                listItem.textContent = place.name || "Unnamed Place";

                listItem.addEventListener("click", () => {
                    map.setCenter(place.geometry.location);
                    new google.maps.Marker({
                        position: place.geometry.location,
                        map,
                        title: place.name
                    });

                    // Calculate and display route
                    if (userLocation) {
                        calculateRoute(userLocation, place.geometry.location);
                    }
                });

                placesList.appendChild(listItem);

                // Add marker to map
                new google.maps.Marker({
                    position: place.geometry.location,
                    map,
                    title: place.name
                });
            });
        }

        // Load the map after the page has loaded
        window.onload = initMap;
    </script>
</body>
</html>
